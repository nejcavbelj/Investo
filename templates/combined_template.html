<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Investo Combined Analysis Report - {{symbol}}</title>
    <style>
        :root {
            --orange: #FFA500; --bg: #181818; --panel: #222; --ink: #fff; --muted: #aaa; --line: #333;
            --green: #00FF00; --amber: #FFC107; --red: #FF3C00; --blue: #6ad1ff; --pink: #FF6B6B;
        }
        * { box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', Arial, sans-serif; background: var(--bg); color: var(--ink); margin: 0;
        }
        .container {
            max-width: 1100px; margin: 40px auto; background: var(--panel); padding: 2em; border-radius: 10px; box-shadow: 0 3px 24px #111;
        }
        h1 { text-align: center; color: var(--orange); letter-spacing: 2px; margin-top: 0; font-size: 2.5em; }
        h2 { color: var(--orange); border-bottom: 2px solid var(--line); padding-bottom: 0.5em; margin-top: 2em; }
        
        .company-info {
            background: #1b1b1b; border: 1px solid var(--line); border-radius: 8px; padding: 1.5em; margin: 1em 0;
            display: flex; align-items: center; gap: 2em;
        }
        .company-logo-container {
            flex-shrink: 0;
        }
        .company-logo {
            width: 100px; height: 100px; border-radius: 50%; 
            border: 3px solid var(--orange); 
            box-shadow: 0 0 20px rgba(255, 165, 0, 0.3);
            object-fit: contain;
            background: linear-gradient(135deg, #ffffff 0%, #f5f5f5 100%);
            padding: 10px;
            display: block;
        }
        .company-details {
            flex: 1;
        }
        .company-info h2 { 
            margin-top: 0; margin-bottom: 0.5em; color: var(--orange);
        }
        .company-info p { margin: 0.5em 0; font-size: 1.1em; }
        .company-info strong { color: var(--blue); }
        
        .analysis-section {
            background: #1b1b1b; border: 1px solid var(--line); border-radius: 8px; padding: 1.5em; margin: 2em 0;
        }
        .analysis-section h2 { margin-top: 0; }
        .graham-section h2 { color: var(--blue); }
        .lynch-section h2 { color: var(--orange); }
        .reddit-section h2 { color: var(--pink); }
        
        table { margin: 1em 0; width: 100%; border-collapse: collapse; background: #181818; }
        th, td { padding: 0.7em 1em; border-bottom: 1px solid var(--line); text-align: left; vertical-align: top; }
        th { background: #202020; color: var(--orange); }
        a { color: var(--orange); text-decoration: underline; }
        
        .grid {
            display: grid; grid-template-columns: repeat(2, minmax(280px, 1fr)); gap: 18px; margin-top: 22px;
        }
        .card {
            background: #1b1b1b; border: 1px solid #242424; border-radius: 10px; padding: 16px;
        }
        .card h3 { margin: 0 0 8px 0; color: var(--orange); font-weight: 600; }
        
        .donut {
            width: 140px; height: 140px; border-radius: 50%; display: inline-grid; place-items: center; margin-right: 14px;
        }
        .donut::after {
            content: ""; width: 88px; height: 88px; background: #1b1b1b; border-radius: 50%;
        }
        .donut-label {
            position: relative; top: -98px; text-align: center; font-weight: 700;
        }
        
        .meter {
            position: relative; height: 16px; width: 100%; border-radius: 999px; background:
                linear-gradient(90deg, var(--red) 0 16.6%, var(--amber) 16.6% 66.6%, var(--green) 66.6% 100%);
            border: 1px solid #2a2a2a; margin-top: 8px;
        }
        .meter .marker {
            position: absolute; top: -6px; width: 2px; height: 28px; background: #fff;
            box-shadow: 0 0 0 2px rgba(255,255,255,0.2);
        }
        
        .badge {
            display: inline-block; padding: .25em .6em; border-radius: 999px; border: 1px solid #2a2a2a; font-weight: 600;
        }
        .small { color: var(--muted); font-size: .92em; }
        
        .sentiment-indicator {
            display: inline-block; padding: 0.3em 0.8em; border-radius: 20px; font-weight: bold; font-size: 0.9em;
        }
        .sentiment-bullish { background-color: #00FF0022; color: #00FF00; border: 1px solid #00FF00; }
        .sentiment-bearish { background-color: #FF3C0022; color: #FF3C00; border: 1px solid #FF3C00; }
        .sentiment-neutral { background-color: #FFA50022; color: #FFA500; border: 1px solid #FFA500; }
        
        .verdict-box {
            background: linear-gradient(135deg, #1a1a1a 0%, #2a2a2a 100%);
            border: 2px solid var(--orange); border-radius: 12px; padding: 1.5em; margin: 2em 0; text-align: center;
        }
        .verdict-box h3 { color: var(--orange); font-size: 1.8em; margin: 0 0 0.5em 0; }
        .verdict-summary { font-size: 1.2em; line-height: 1.6; margin: 1em 0; }
        .verdict-summary .sentiment-indicator { 
            font-size: 1.5em; font-weight: bold; padding: 0.5em 1em; 
            border-radius: 8px; display: inline-block; margin-bottom: 0.5em;
        }
        .verdict-summary p { margin: 1em 0; color: var(--ink); }
        .verdict-breakdown { 
            margin-top: 1.5em; padding: 1em; background: rgba(0,0,0,0.3); 
            border-radius: 8px; text-align: left; display: inline-block;
        }
        .verdict-breakdown strong { color: var(--orange); }
        .disclaimer { 
            margin-top: 1.5em; padding-top: 1em; border-top: 1px solid var(--line); 
            color: var(--muted); font-style: italic;
        }
        
        .footer { text-align: center; margin-top: 3em; padding-top: 2em; border-top: 1px solid var(--line); color: var(--muted); }
        
        /* Dynamic styling for badges and elements */
        .reliability-badge[data-index] {
            background: #FF3C0022;
            border-color: #FF3C00;
            color: #FF3C00;
        }
        .reliability-badge[data-index="40"], .reliability-badge[data-index="41"], .reliability-badge[data-index="42"], 
        .reliability-badge[data-index="43"], .reliability-badge[data-index="44"], .reliability-badge[data-index="45"], 
        .reliability-badge[data-index="46"], .reliability-badge[data-index="47"], .reliability-badge[data-index="48"], 
        .reliability-badge[data-index="49"], .reliability-badge[data-index="50"], .reliability-badge[data-index="51"], 
        .reliability-badge[data-index="52"], .reliability-badge[data-index="53"], .reliability-badge[data-index="54"], 
        .reliability-badge[data-index="55"], .reliability-badge[data-index="56"], .reliability-badge[data-index="57"], 
        .reliability-badge[data-index="58"], .reliability-badge[data-index="59"], .reliability-badge[data-index="60"], 
        .reliability-badge[data-index="61"], .reliability-badge[data-index="62"], .reliability-badge[data-index="63"], 
        .reliability-badge[data-index="64"], .reliability-badge[data-index="65"], .reliability-badge[data-index="66"], 
        .reliability-badge[data-index="67"], .reliability-badge[data-index="68"], .reliability-badge[data-index="69"] {
            background: #FFA50022;
            border-color: #FFA500;
            color: #FFA500;
        }
        .reliability-badge[data-index="70"], .reliability-badge[data-index="71"], .reliability-badge[data-index="72"], 
        .reliability-badge[data-index="73"], .reliability-badge[data-index="74"], .reliability-badge[data-index="75"], 
        .reliability-badge[data-index="76"], .reliability-badge[data-index="77"], .reliability-badge[data-index="78"], 
        .reliability-badge[data-index="79"], .reliability-badge[data-index="80"], .reliability-badge[data-index="81"], 
        .reliability-badge[data-index="82"], .reliability-badge[data-index="83"], .reliability-badge[data-index="84"], 
        .reliability-badge[data-index="85"], .reliability-badge[data-index="86"], .reliability-badge[data-index="87"], 
        .reliability-badge[data-index="88"], .reliability-badge[data-index="89"], .reliability-badge[data-index="90"], 
        .reliability-badge[data-index="91"], .reliability-badge[data-index="92"], .reliability-badge[data-index="93"], 
        .reliability-badge[data-index="94"], .reliability-badge[data-index="95"], .reliability-badge[data-index="96"], 
        .reliability-badge[data-index="97"], .reliability-badge[data-index="98"], .reliability-badge[data-index="99"], 
        .reliability-badge[data-index="100"] {
            background: #00FF0022;
            border-color: #00FF00;
            color: #00FF00;
        }
        
        .reddit-score[data-verdict="Bullish"] { color: #00FF00; }
        .reddit-score[data-verdict="Neutral"] { color: #FFA500; }
        .reddit-score[data-verdict="Bearish"] { color: #FF3C00; }
        
        .verdict-donut[data-verdict="Bullish"] { background: conic-gradient(var(--green) 100%, #333 0%); }
        .verdict-donut[data-verdict="Neutral"] { background: conic-gradient(var(--amber) 100%, #333 0%); }
        .verdict-donut[data-verdict="Bearish"] { background: conic-gradient(var(--red) 100%, #333 0%); }
        
        /* Chart styling - now handled by chart module */
        {{ chart_css | safe }}
        
        /* News Section Styling */
        .news-section {
            background: #1b1b1b; border: 2px solid var(--orange); border-radius: 12px; 
            padding: 1.5em; margin: 2em 0; box-shadow: 0 4px 16px rgba(255, 165, 0, 0.1);
        }
        .news-section h2 { margin-top: 0; color: var(--orange); font-size: 1.8em; }
        .news-item {
            background: #0a0a0a; border: 1px solid #333; border-radius: 8px; 
            padding: 1.2em; margin: 1em 0; transition: all 0.3s ease;
        }
        .news-item:hover {
            border-color: var(--orange); box-shadow: 0 0 15px rgba(255, 165, 0, 0.2);
            transform: translateX(5px);
        }
        .news-item h3 { margin: 0 0 0.5em 0; color: var(--blue); font-size: 1.2em; }
        .news-item h3 a { color: var(--blue); text-decoration: none; }
        .news-item h3 a:hover { color: var(--orange); }
        .news-meta { color: var(--muted); font-size: 0.9em; margin-top: 0.5em; }
        .news-source { 
            color: var(--orange); font-weight: 700; 
            padding: 0.2em 0.5em; background: rgba(255, 165, 0, 0.1); 
            border-radius: 4px; border: 1px solid var(--orange);
        }
        .news-publisher { color: var(--blue); font-weight: 600; }
        .news-time { color: var(--muted); font-style: italic; }
        
        /* Report Buttons Section */
        .reports-section {
            margin: 2em 0;
        }
        .report-button {
            background: linear-gradient(135deg, #1a1a1a 0%, #2a2a2a 100%);
            border: 2px solid var(--line); border-radius: 12px; 
            padding: 1.5em; margin: 1em 0; cursor: pointer;
            transition: all 0.3s ease;
        }
        .report-button:hover {
            border-color: var(--orange); box-shadow: 0 0 20px rgba(255, 165, 0, 0.3);
            transform: scale(1.02);
        }
        .report-button.graham:hover { border-color: var(--blue); box-shadow: 0 0 20px rgba(106, 209, 255, 0.3); }
        .report-button.lynch:hover { border-color: var(--orange); }
        .report-button.reddit:hover { border-color: var(--pink); box-shadow: 0 0 20px rgba(255, 107, 107, 0.3); }
        
        .report-button h3 { 
            margin: 0; font-size: 1.6em; 
            display: flex; align-items: center; justify-content: space-between;
        }
        .report-button.graham h3 { color: var(--blue); }
        .report-button.lynch h3 { color: var(--orange); }
        .report-button.reddit h3 { color: var(--pink); }
        
        .report-button p { margin: 0.5em 0 0 0; color: var(--muted); }
        .expand-icon {
            font-size: 1.2em; transition: transform 0.3s ease;
        }
        .expand-icon.rotated { transform: rotate(180deg); }
        
        /* Collapsible Content */
        .report-content {
            max-height: 0; overflow: hidden; 
            transition: max-height 0.5s ease;
        }
        .report-content.expanded {
            max-height: 10000px;
        }
        .report-content-inner {
            padding-top: 1.5em; border-top: 1px solid var(--line); margin-top: 1em;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Investo Combined Analysis Report: {{symbol}}</h1>
        
        <div class="company-info">
            <div class="company-logo-container">
                <img src="https://assets.parqet.com/logos/symbol/{{symbol}}?format=png" 
                     alt="{{symbol}} logo" 
                     class="company-logo"
                     onerror="this.onerror=null; this.src='https://logo.clearbit.com/{{symbol | lower}}.com'; this.onerror=function(){this.src='data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 width=%22100%22 height=%22100%22%3E%3Crect fill=%22%23FFA500%22 width=%22100%22 height=%22100%22/%3E%3Ctext x=%2250%25%22 y=%2250%25%22 dominant-baseline=%22middle%22 text-anchor=%22middle%22 font-family=%22Arial%22 font-size=%2230%22 fill=%22%23181818%22 font-weight=%22bold%22%3E{{symbol}}%3C/text%3E%3C/svg%3E';};">
            </div>
            <div class="company-details">
                <h2>Company Information</h2>
                <p><strong>Name:</strong> {{company_name}}</p>
                <p><strong>Price:</strong> ${{price}}</p>
                <p><strong>Sector:</strong> {{sector}}</p>
                <p><strong>Industry:</strong> {{industry}}</p>
                <p><strong>Market Cap:</strong> ${{market_cap}}</p>
            </div>
        </div>
        
        <!-- Stock Price Chart Section - Generated by chart module -->
        {{ chart_html | safe }}
        
        <!-- Latest News Section -->
        {% if yahoo_news %}
        <div class="news-section">
            <h2>Latest News</h2>
            {% for news in yahoo_news %}
            <div class="news-item">
                <h3><a href="{{news.link}}" target="_blank">{{news.title}}</a></h3>
                <div class="news-meta">
                    <span class="news-source">{{news.source}}</span> • 
                    <span class="news-publisher">{{news.publisher}}</span> • 
                    <span class="news-time">{{news.publish_time}}</span>
                </div>
            </div>
            {% endfor %}
        </div>
        {% endif %}
        
        <!-- Analysis Reports Section -->
        <div class="reports-section">
            <h2 style="color: var(--orange); text-align: center; margin-bottom: 1.5em;">Analysis Reports</h2>
            
            <!-- Benjamin Graham Report Button -->
            <div class="report-button graham" onclick="toggleReport('graham')">
                <h3>
                    <span>Benjamin Graham Analysis</span>
                    <span class="expand-icon" id="graham-icon">▼</span>
                </h3>
                <p>Value investing & defensive stock criteria</p>
                <div class="report-content" id="graham-content">
                    <div class="report-content-inner">
                        <!-- Graham Analysis Section -->
        <div class="analysis-section graham-section">
            <h2>Benjamin Graham Analysis</h2>
            
            <table>
                <tr><th>Metric</th><th>Value</th><th>Graham Criteria</th><th>Status</th></tr>
                {% for metric, value in graham_metrics.items() %}
                {% if metric not in ['sector', 'industry', 'price', 'marketCap', 'Graham_Combined_Test'] %}
                <tr>
                    <td>{{metric.replace('_', ' ')}}</td>
                    <td>{{value if value is not none else 'N/A'}}</td>
                    <td>{{get_graham_criteria(metric)}}</td>
                    <td>
                        {% if check_graham_criteria(metric, value) %}
                            <span class="sentiment-indicator sentiment-bullish">✓</span>
                        {% else %}
                            <span class="sentiment-indicator sentiment-bearish">✗</span>
                        {% endif %}
                    </td>
                </tr>
                {% endif %}
                {% endfor %}
            </table>
            
            <div class="grid">
                <div class="card">
                    <h3>Graham Combined Test</h3>
                    {% if graham_metrics.Graham_Combined_Test %}
                        <div class="donut" style="background: conic-gradient(var(--green) 100%, #333 0);"></div>
                        <div class="donut-label">PASS</div>
                        <div class="small">All Graham criteria met</div>
                    {% else %}
                        <div class="donut" style="background: conic-gradient(var(--red) 100%, #333 0);"></div>
                        <div class="donut-label">FAIL</div>
                        <div class="small">Some criteria not met</div>
                    {% endif %}
                </div>
                
                <div class="card">
                    <h3>Margin of Safety</h3>
                    {% if graham_metrics.get('Margin_of_Safety_%') %}
                        {% set mos = graham_metrics.get('Margin_of_Safety_%') %}
                        {% set mos_pct = (mos / 50 * 100) | round %}
                        <div class="donut" style="background: conic-gradient(var(--green) {{mos_pct}}%, #333 0%);"></div>
                        <div class="donut-label">{{mos|round(1)}}%</div>
                        <div class="small">Higher is safer</div>
                    {% else %}
                        <div class="donut" style="background: conic-gradient(var(--red) 100%, #333 0);"></div>
                        <div class="donut-label">N/A</div>
                        <div class="small">Cannot calculate</div>
                    {% endif %}
                </div>
            </div>
            
            {% if graham_metrics.NetNet_Comment %}
            <div class="card" style="margin-top: 1em;">
                <h3>Net-Net Analysis</h3>
                <p>{{graham_metrics.NetNet_Comment}}</p>
            </div>
            {% endif %}
        </div>
        
                    </div>
                </div>
            </div>
            
            <!-- Peter Lynch Report Button -->
            <div class="report-button lynch" onclick="toggleReport('lynch')">
                <h3>
                    <span>Peter Lynch Analysis</span>
                    <span class="expand-icon" id="lynch-icon">▼</span>
                </h3>
                <p>Growth investing & PEG ratio analysis</p>
                <div class="report-content" id="lynch-content">
                    <div class="report-content-inner">
                        <!-- Lynch Analysis Section -->
        <div class="analysis-section lynch-section">
            <h2>Peter Lynch Analysis</h2>
            
            <table>
                <tr><th>Metric</th><th>Value</th><th>Lynch Criteria</th><th>Status</th></tr>
                {% for metric, value in lynch_metrics.items() %}
                {% if metric not in ['sector', 'industry'] %}
                <tr>
                    <td>{{metric.replace('_', ' ')}}</td>
                    <td>{{value if value is not none else 'N/A'}}</td>
                    <td>{{get_lynch_criteria(metric)}}</td>
                    <td>
                        {% if check_lynch_criteria(metric, value) %}
                            <span class="sentiment-indicator sentiment-bullish">✓</span>
                        {% else %}
                            <span class="sentiment-indicator sentiment-bearish">✗</span>
                        {% endif %}
                    </td>
                </tr>
                {% endif %}
                {% endfor %}
            </table>
            
            <div class="grid">
                <div class="card">
                    <h3>PEG Ratio Analysis</h3>
                    {% set peg = lynch_metrics.PEG %}
                    {% if peg %}
                        {% if peg < 1.0 %}
                            <div class="donut" style="background: conic-gradient(var(--green) 100%, #333 0);"></div>
                            <div class="donut-label">EXCELLENT</div>
                            <div class="small">PEG: {{peg|round(2)}} &lt; 1.0</div>
                        {% elif peg < 1.5 %}
                            <div class="donut" style="background: conic-gradient(var(--amber) 100%, #333 0);"></div>
                            <div class="donut-label">GOOD</div>
                            <div class="small">PEG: {{peg|round(2)}} &lt; 1.5</div>
                        {% else %}
                            <div class="donut" style="background: conic-gradient(var(--red) 100%, #333 0);"></div>
                            <div class="donut-label">HIGH</div>
                            <div class="small">PEG: {{peg|round(2)}} &gt; 1.5</div>
                        {% endif %}
                    {% else %}
                        <div class="donut" style="background: conic-gradient(var(--red) 100%, #333 0);"></div>
                        <div class="donut-label">N/A</div>
                        <div class="small">Cannot calculate</div>
                    {% endif %}
                </div>
                
                <div class="card">
                    <h3>Growth Analysis</h3>
                    {% if lynch_metrics.get('EPS_Growth_%') %}
                        {% set growth = lynch_metrics.get('EPS_Growth_%') %}
                        {% set growth_pct = (growth / 20 * 100) | round %}
                        <div class="donut" style="background: conic-gradient(var(--green) {{growth_pct}}%, #333 0%);"></div>
                        <div class="donut-label">{{growth|round(1)}}%</div>
                        <div class="small">EPS Growth Rate</div>
                    {% else %}
                        <div class="donut" style="background: conic-gradient(var(--red) 100%, #333 0);"></div>
                        <div class="donut-label">N/A</div>
                        <div class="small">No growth data</div>
                    {% endif %}
                </div>
            </div>
        </div>
        
                    </div>
                </div>
            </div>
            
            <!-- Reddit Sentiment Report Button -->
            <div class="report-button reddit" onclick="toggleReport('reddit')">
                <h3>
                    <span>Reddit Sentiment Analysis</span>
                    <span class="expand-icon" id="reddit-icon">▼</span>
                </h3>
                <p>Community sentiment & social media buzz</p>
                <div class="report-content" id="reddit-content">
                    <div class="report-content-inner">
                        <!-- Reddit Analysis Section -->
        <div class="analysis-section reddit-section">
            <h2>Reddit Sentiment Analysis</h2>
            
            <table>
                <tr><th>Metric</th><th>Value</th><th>Interpretation</th></tr>
                <tr><td>Mentions (last 14 days)</td><td>{{reddit_data.mentions}}</td><td>Activity level on Reddit</td></tr>
                <tr><td>Average Sentiment</td><td>{{reddit_data.avg_sentiment}} → {{reddit_data.verdict}}</td><td>Crowd tone (Bullish/Neutral/Bearish)</td></tr>
                <tr><td>Sentiment Confidence</td><td>{{(reddit_data.sentiment_confidence * 100)|round|int}}%</td><td>Agreement level among posts</td></tr>
                <tr><td>Buzz Ratio</td><td>{{reddit_data.buzz_ratio}}×</td><td>Mentions vs last week (proxy)</td></tr>
                <tr><td>Reliability Index</td><td><span class="badge reliability-badge" data-index="{{reddit_data.reliability_index}}">{{reddit_data.reliability_index}}/100</span></td><td>Composite confidence in Reddit signal</td></tr>
                <tr><td>Composite Reddit Score</td><td class="reddit-score" data-verdict="{{reddit_data.verdict}}"><b>{{reddit_data.reddit_score}}/100</b></td><td>Investo composite Reddit signal</td></tr>
            </table>
            
            <div class="grid">
                <div class="card">
                    <h3>Sentiment Confidence</h3>
                    {% set conf_pct = (reddit_data.sentiment_confidence * 100) | round | int %}
                    <div class="donut" style="background: conic-gradient(var(--green) {{conf_pct}}%, #333 0%);"></div>
                    <div class="donut-label">{{conf_pct}}%</div>
                    <div class="small">Lower std dev → higher confidence</div>
                </div>
                
                <div class="card">
                    <h3>Buzz Meter (0–3×)</h3>
                    {% set buzz_pos = ((reddit_data.buzz_ratio / 3) * 100) | round %}
                    <div class="meter">
                        <div class="marker buzz-marker" data-position="{{buzz_pos}}" title="Buzz position"></div>
                    </div>
                    <div class="small" style="margin-top:6px;">
                        <span style="color:var(--red)">Fading (&lt;0.5×)</span> ·
                        <span style="color:var(--amber)">Healthy (0.5–2×)</span> ·
                        <span style="color:var(--green)">Hype (&gt;2×)</span>
                    </div>
                </div>
                
                <div class="card">
                    <h3>Analytical vs Emotional</h3>
                    {% set dd_pct = (reddit_data.dd_quality_ratio * 100) | round | int %}
                    <div class="donut" style="background: conic-gradient(var(--orange) {{dd_pct}}%, #444 0%);"></div>
                    <div class="donut-label">{{dd_pct}}%</div>
                    <div class="small">Analytical posts (DD/earnings)</div>
                </div>
                
                <div class="card">
                    <h3>Overall Verdict</h3>
                    <div class="donut verdict-donut" data-verdict="{{reddit_data.verdict}}"></div>
                    <div class="donut-label">{{reddit_data.verdict}}</div>
                    <div class="small">Score: {{reddit_data.reddit_score}}/100</div>
                </div>
            </div>
        </div>
        
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Combined Verdict - Loaded from separate template -->
        {% include 'verdict_template.html' %}
        
        <div class="footer">
            <p>Generated by Investo - Combined Analysis System</p>
            <p>Report generated on {{generation_date}}</p>
        </div>
    </div>
    
    <script>
        // Set buzz marker position dynamically
        document.addEventListener('DOMContentLoaded', function() {
            const buzzMarker = document.querySelector('.buzz-marker');
            if (buzzMarker) {
                const position = buzzMarker.getAttribute('data-position');
                if (position) {
                    buzzMarker.style.left = position + '%';
                }
            }
        });
        
        // Toggle report sections
        function toggleReport(reportType) {
            const content = document.getElementById(reportType + '-content');
            const icon = document.getElementById(reportType + '-icon');
            
            if (content.classList.contains('expanded')) {
                content.classList.remove('expanded');
                icon.classList.remove('rotated');
            } else {
                // Close all other reports
                document.querySelectorAll('.report-content').forEach(function(el) {
                    el.classList.remove('expanded');
                });
                document.querySelectorAll('.expand-icon').forEach(function(el) {
                    el.classList.remove('rotated');
                });
                
                // Open clicked report
                content.classList.add('expanded');
                icon.classList.add('rotated');
            }
        }
    </script>

    <!-- Flash Messages (only when rendered via Flask) -->
    {% if get_flashed_messages is defined %}
      {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
          <div style="margin: 1rem 0;">
            {% for category, message in messages %}
              <div style="padding: 1rem; border-radius: 8px; margin-bottom: 0.5rem; 
                          background: {% if category == 'success' %}#1a4d2e{% else %}#4d1a1a{% endif %}; 
                          border: 1px solid {% if category == 'success' %}#2d7a4d{% else %}#7a2d2d{% endif %}; 
                          color: {% if category == 'success' %}#66ff99{% else %}#ff6666{% endif %};">
                {{ message }}
              </div>
            {% endfor %}
          </div>
        {% endif %}
      {% endwith %}
    {% endif %}

    <!-- Feedback Section -->
    <div class="feedback-section">
        <h2 style="color: var(--orange); margin-top: 0;">💬 Share Your Feedback</h2>
        <p style="color: var(--muted); font-size: 1em; margin-bottom: 1.5em;">
          We'd love to hear what you think about Investo and this analysis report.
        </p>
      
        <form id="feedbackForm" method="post" action="/feedback">
          <div style="margin-bottom: 1em;">
            <textarea 
              id="feedbackMessage"
              name="message" 
              rows="5" 
              placeholder="Share your thoughts, suggestions, or report issues..."
              style="
                width: 100%;
                background: #181818;
                border: 1px solid var(--line);
                border-radius: 8px;
                padding: 1em;
                color: var(--ink);
                font-family: 'Segoe UI', Arial, sans-serif;
                font-size: 1em;
                resize: vertical;
                transition: border-color 0.3s ease;
              "
              onfocus="this.style.borderColor='var(--orange)'"
              onblur="this.style.borderColor='var(--line)'"
              required
            ></textarea>
          </div>
          
          <div style="display: flex; gap: 1em; align-items: center; flex-wrap: wrap;">
            <input 
              type="text" 
              name="user" 
              id="feedbackUser"
              placeholder="Your name (optional)" 
              style="
                flex: 1;
                min-width: 200px;
                background: #181818;
                border: 1px solid var(--line);
                border-radius: 8px;
                padding: 0.8em 1em;
                color: var(--ink);
                font-family: 'Segoe UI', Arial, sans-serif;
                font-size: 1em;
                transition: border-color 0.3s ease;
              "
              onfocus="this.style.borderColor='var(--orange)'"
              onblur="this.style.borderColor='var(--line)'"
            >
            <button 
              type="submit" 
              id="feedbackSubmitBtn"
              style="
                background: linear-gradient(135deg, var(--orange) 0%, #ff8c00 100%);
                color: #000;
                border: none;
                border-radius: 8px;
                padding: 0.8em 2em;
                font-weight: 600;
                font-size: 1em;
                cursor: pointer;
                transition: all 0.3s ease;
                box-shadow: 0 2px 8px rgba(255, 165, 0, 0.3);
              "
              onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 12px rgba(255, 165, 0, 0.5)'"
              onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 8px rgba(255, 165, 0, 0.3)'"
            >
              Send Feedback
            </button>
          </div>
        </form>

        <!-- Feedback Response Message -->
        <div id="feedbackResponse" style="display: none; margin-top: 1em; padding: 1em; border-radius: 8px;"></div>
    </div>

    <script>
      // AJAX Feedback Form Submission
      document.getElementById('feedbackForm').addEventListener('submit', function(e) {
        e.preventDefault();
        
        const form = this;
        const submitBtn = document.getElementById('feedbackSubmitBtn');
        const responseDiv = document.getElementById('feedbackResponse');
        const message = document.getElementById('feedbackMessage').value;
        const user = document.getElementById('feedbackUser').value;
        
        // Disable button and show loading state
        submitBtn.disabled = true;
        submitBtn.textContent = 'Sending...';
        submitBtn.style.opacity = '0.6';
        responseDiv.style.display = 'none';
        
        // Create FormData
        const formData = new FormData(form);
        
        // Submit via fetch
        fetch('/feedback', {
          method: 'POST',
          body: formData
        })
        .then(response => {
          // Check if redirect happened (form submission worked)
          if (response.redirected) {
            // Show success message
            showFeedbackMessage('✅ Thank you for your feedback! We appreciate your input.', 'success');
            form.reset();
          } else {
            return response.text().then(text => {
              // Parse for flash messages or show generic success
              showFeedbackMessage('✅ Thank you for your feedback!', 'success');
              form.reset();
            });
          }
        })
        .catch(error => {
          console.error('Feedback error:', error);
          showFeedbackMessage('❌ Failed to send feedback. Please try again.', 'error');
        })
        .finally(() => {
          // Re-enable button
          submitBtn.disabled = false;
          submitBtn.textContent = 'Send Feedback';
          submitBtn.style.opacity = '1';
        });
      });
      
      function showFeedbackMessage(message, type) {
        const responseDiv = document.getElementById('feedbackResponse');
        
        if (type === 'success') {
          responseDiv.style.background = '#1a4d2e';
          responseDiv.style.border = '1px solid #2d7a4d';
          responseDiv.style.color = '#66ff99';
        } else {
          responseDiv.style.background = '#4d1a1a';
          responseDiv.style.border = '1px solid #7a2d2d';
          responseDiv.style.color = '#ff6666';
        }
        
        responseDiv.textContent = message;
        responseDiv.style.display = 'block';
        
        // Auto-hide success message after 5 seconds
        if (type === 'success') {
          setTimeout(() => {
            responseDiv.style.display = 'none';
          }, 5000);
        }
      }
    </script>
      
</body>
</html>
